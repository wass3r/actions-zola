name: Test Action

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-version-validation:
    name: Test version validation
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version:
          - v0.20.0 # Minimum supported
          - v0.21.0 # Default
          - v0.19.0 # Should fail
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Test with ${{ matrix.version }}
        id: test
        continue-on-error: true
        uses: ./
        with:
          zola_version: ${{ matrix.version }}
          root: test-site

      - name: Verify v0.19.0 failed
        if: matrix.version == 'v0.19.0'
        run: |
          if [ "${{ steps.test.outcome }}" != "failure" ]; then
            echo "::error::Expected v0.19.0 to fail version check"
            exit 1
          fi
          echo "✅ v0.19.0 correctly rejected"

      - name: Verify supported versions succeeded
        if: matrix.version != 'v0.19.0'
        run: |
          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "::error::Expected ${{ matrix.version }} to succeed"
            exit 1
          fi
          echo "✅ ${{ matrix.version }} worked correctly"

  test-platforms:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        zola_version: [v0.20.0, v0.21.0]
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Build test site
        uses: ./
        with:
          zola_version: ${{ matrix.zola_version }}
          root: test-site

      - name: Verify output exists
        shell: bash
        run: |
          if [ ! -d "test-site/public" ]; then
            echo "::error::Expected public/ directory not found"
            exit 1
          fi
          if [ ! -f "test-site/public/index.html" ]; then
            echo "::error::Expected index.html not found"
            exit 1
          fi
          echo "✅ Build output verified"

      - name: Upload build artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: site-${{ matrix.os }}-${{ matrix.zola_version }}
          path: test-site/public/

  test-options:
    name: Test build options
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Test with custom base_url
        uses: ./
        with:
          root: test-site
          base_url: https://example.com

      - name: Test with custom output_dir
        uses: ./
        with:
          root: test-site
          output_dir: test-site/dist

      - name: Verify custom output directory
        run: |
          if [ ! -d "test-site/dist" ]; then
            echo "::error::Custom output directory not found"
            exit 1
          fi
          echo "✅ Custom output_dir worked"

      - name: Test with drafts enabled
        uses: ./
        with:
          root: test-site
          drafts: true

  test-caching:
    name: Test binary caching
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: First build (cache miss)
        uses: ./
        with:
          root: test-site

      - name: Second build (cache hit)
        uses: ./
        with:
          root: test-site

      - name: Verify Zola still works after cache
        run: |
          zola --version
          echo "✅ Cached binary works"
